# Desktop MVP Slim Branch - Work Plan / TODO

## Working Agreements (Must Follow)

Verbatim requirements (from user):

> 1) 无论接下来做什么，都要把计划和 todo 列表放在一个 work.md 或 todo.md 这类文件里。
> 2) 每完成一个阶段的工作，就把上一阶段的经验教训更新到 agents.md 里。
> 3) 当一个计划完成并且代码合并后，把这个工作的设计文档添加到项目的知识库中（.codex/knowledge）。

Operationalization:

- Keep the active plan + TODOs in `todo.md` (this file) or `work.md`. Prefer `todo.md` unless the file gets too large.
- When a phase completes, append a short "Lessons Learned" entry for that phase to `AGENTS.md`.
- When the plan is fully completed and merged, add a design doc to `.codex/knowledge/` (create the directory if missing).

## Goals

- Produce a "desktop MVP slim" branch that keeps the desktop experience usable while cutting non-desktop scope.
- Decide desktop gateway auth UX (token/device token) without weakening security.
- Keep `cli_model` as a long-term supported capability (not a temporary hack).

## Current State (Snapshot: 2026-02-09)

- Work is on `desktop-mvp-slim`, rebased onto current `origin/main` (no longer behind).
- Baseline state (from `origin/main`): Android/iOS removed; most `extensions/*` removed; Windows desktop app present.
- Gates are not green (typecheck/tests/lint/format issues remain).

## Top Risks / Must-Fix Findings (From Review)

- Gateway auth bypass: "localDirect" requests can skip auth based on spoofable headers (User-Agent/Host).
- `cli_model` tool: executes shell command strings via PowerShell (`exec` + interpolation), unsafe by default and bypasses exec policy.
- `fs_read` tool: workspace boundary check is symlink-bypassable; file reads are unbounded; output includes non-ASCII icons.
- Logging: debug/info logs include user/assistant text snippets (risk of leaking sensitive content to logs).

## Decisions (Pending)

- Desktop token strategy:
- Desktop slim gating strategy (env/config driven vs hardcoded):
- Desktop minimal toolset strategy (default vs opt-in):
- Plugin strategy for slim build (keep disabled vs remove references/tests):

## Phase Plan

### Phase 0 - Branch Hygiene / Baseline

TODO:

- [x] Create a dedicated branch for this work (do not continue directly on `main`). (Created: `desktop-mvp-slim`)
- [x] Sync with `origin/main` early so the slim branch is based on current head. (Rebased: 2026-02-09)
- [x] Define "what must stay green" for this slim branch.

Green gates (run before push):

- `pnpm check` (typecheck + lint + format)
- `pnpm build`
- `pnpm ui:build`
- `pnpm test` (unit + gateway)
- Windows desktop: `pnpm --dir apps/windows typecheck` and `pnpm --dir apps/windows build`

Lessons Learned (to append to `AGENTS.md` when Phase 0 completes):

- Completed: appended to `AGENTS.md` (2026-02-09).

### Phase 1 - Security Hardening (Blockers)

TODO:

- [x] Remove or redesign the "localDirect skips auth" behavior.

Notes:

- `isLocalDirectRequest()` now requires loopback client IP (no User-Agent/Host-only shortcuts).
- `authorizeGatewayConnect()` no longer skips token/password for localDirect requests (so HTTP endpoints like `/tools/invoke` require auth).

- [x] Restore expected auth semantics and fix affected tests (`src/gateway/auth.test.ts`, `src/gateway/tools-invoke-http.test.ts`).
- [x] `cli_model`: disabled by default (opt-in via `tools.cliModel.enabled`).
- [x] `cli_model`: restrict `action` to a strict enum / allowlist.
- [x] `cli_model`: replace shell-string `exec()` with a safe spawn/execFile strategy (no shell injection).
- [x] `cli_model`: add timeouts, output limits, and integrate with existing exec security/approval policy.
- [x] `fs_read`: prevent symlink escape (use `lstat` and/or `realpath` checks).
- [x] `fs_read`: add max-bytes + truncation for file reads and directory trees.
- [x] `fs_read`: keep output ASCII-only (no emoji icons).
- [x] Logging: remove or gate logs that include message content snippets (reply dispatcher, webchat, UI debug logs).

Lessons Learned (to append to `AGENTS.md` when Phase 1 completes):

- Completed: appended to `AGENTS.md` (2026-02-10).

### Phase 2 - Typecheck / Lint / Format Green

TODO:

- Fix `pnpm tsgo` errors:
- `src/cli/gateway-cli/dev.ts`: type `baseConfig` as `OpenClawConfig` (avoid string widening).
- `ui/src/ui/app-view-state.ts`: add `chatWaitingForResponse`.
- `ui/src/ui/controllers/chat.test.ts`: ensure `chatWaitingForResponse` is always provided (boolean).
- Run and fix `pnpm check` (lint + format) until clean.

Lessons Learned (to append to `AGENTS.md` when Phase 2 completes):

- TBD

### Phase 3 - Desktop Auth UX ("Tokenless Feel", Still Secure)

TODO:

- Goal: keep Gateway auth enabled, but make desktop feel "tokenless" (no copy/paste) without weakening security.
- Constraints:
- No token/password in URL query params.
- No token/password in process args.
- Do not log token/password.

- Decision (recommended):
- Use a per-install random token (not password) generated by the desktop app.
- Persist the token locally (desktop-private storage).
- Pass token to the Gateway via env `OPENCLAW_GATEWAY_TOKEN`.
- Seed the Control UI settings token via desktop preload (localStorage) on loopback origins only.

- Windows desktop (apps/windows):
- [x] Add a small token store (generate/persist/rotate) under Electron `app.getPath("userData")`.
- [x] Gateway spawn:
- Always pass `--profile desktop` so state/config paths are isolated.
- Always pass `--allow-unconfigured --bind loopback --port <port> --auth token`.
- Set env `OPENCLAW_GATEWAY_TOKEN=<token>` (and override `OPENCLAW_GATEWAY_PASSWORD=""`).
- Remove/guard logs that might leak secrets (avoid logging full stdout/stderr by default).
- [x] Preload auth seeding:
- Sync IPC to fetch `{ token, port }` from main.
- If `location.hostname` is loopback and `location.port` matches, write `openclaw.control.settings.v1`:
- Set `token` to the desktop token.
- Ensure `gatewayUrl` is `ws://127.0.0.1:<port>` (do not clobber remote URLs).
- Never expose token on `window.*` globals.
- [x] Add "Rotate Desktop Token" tray menu action:
- Rotate token -> restart gateway -> reload chat window.

- macOS desktop (apps/macos) follow-up (likely needed):
- [ ] Stop adding token/password as dashboard URL query params (`GatewayEndpointStore.dashboardURL`).
- [ ] Replace with a tokenless "auth bridge" approach (TBD): in-app webview seeding localStorage, or a local HTML bridge that seeds storage then redirects, without query params.

- Docs:
- [ ] Add a short doc on "Desktop Auth" + recovery:
- How token is generated/stored.
- How to rotate token.
- How to reset Control UI localStorage if needed.

Lessons Learned (to append to `AGENTS.md` when Phase 3 completes):

- TBD

### Phase 4 - Slim Scope Alignment (Plugins, Tests, Packaging)

TODO:

- Decide plugin strategy for slim branch:
- Option A: keep plugin system, but disabled by default in desktop slim mode; keep core plugin catalog/tests adjusted.
- Option B: remove plugin catalog usage and adjust tests to not import deleted `extensions/*`.
- Align CLI behavior with slim mode (avoid half-disabled code paths like "empty plugin registration block").
- Get `pnpm test` green under the decided scope (may require updating/removing extension-dependent tests).

Lessons Learned (to append to `AGENTS.md` when Phase 4 completes):

- TBD

### Phase 5 - Wrap Up / Merge / Knowledge Base

TODO:

- Add a design doc for this work into `.codex/knowledge/` after the plan is complete and merged.
- Ensure `AGENTS.md` contains the phase-by-phase "Lessons Learned" entries.

Lessons Learned (to append to `AGENTS.md` when Phase 5 completes):

- TBD
